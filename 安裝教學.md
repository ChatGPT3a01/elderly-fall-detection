# 樂齡防傾倒 LINE Bot 通知系統 - 完整安裝部署教學

## 系統簡介

本系統使用 AI 影像辨識技術，透過攝影機即時監控長者活動，計算身體傾斜角度，當偵測到跌倒時自動發送 LINE 通知給照護者。

### 功能特色
- 即時人體姿態偵測（MediaPipe Pose）
- 軀幹傾斜角度計算
- 多指標跌倒判斷（角度、頭部下降、中心位移）
- LINE 即時通知（支援 Flex Message 卡片）
- 跌倒圖片自動儲存
- 防誤判機制（連續偵測確認、多指標交叉驗證）
- 通知冷卻時間（避免重複通知）
- 校準功能（站立時按 c 鍵校準）

---

## 第一部分：環境準備

### 1.1 系統需求

| 項目 | 需求 |
|------|------|
| 作業系統 | Windows 10/11、macOS、Linux |
| Python | 3.8 ~ 3.11（建議 3.10） |
| 攝影機 | 內建或 USB 網路攝影機 |
| 網路 | 需要網路連線（發送 LINE 通知） |

### 1.2 安裝 Python

如果電腦尚未安裝 Python：

1. 前往 [Python 官網](https://www.python.org/downloads/)
2. 下載 Python 3.10.x 版本
3. 執行安裝程式
4. **重要！** 勾選 `Add Python to PATH`
5. 點擊 `Install Now`

### 1.3 確認 Python 安裝成功

打開「命令提示字元」（按 `Win + R`，輸入 `cmd`，按 Enter）

輸入以下指令：
```bash
python --version
```

應該會顯示類似：`Python 3.10.x`

---

## 第二部分：安裝專案套件

### 2.1 開啟命令提示字元

1. 按 `Win + R`
2. 輸入 `cmd`
3. 按 Enter

### 2.2 進入專案資料夾

```bash
cd "D:\20251206\elderly_fall_detection"
```

> 提示：可以在檔案總管中，按住 Shift 並右鍵點擊資料夾，選擇「在此處開啟命令視窗」

### 2.3 建立虛擬環境（建議）

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# macOS / Linux
python3 -m venv venv
source venv/bin/activate
```

### 2.4 安裝所需套件

```bash
pip install -r requirements.txt
```

等待安裝完成，約需 2-5 分鐘。

### 2.5 驗證安裝成功

```bash
python -c "import cv2; import mediapipe; print('安裝成功！')"
```

如果顯示「安裝成功！」表示套件安裝正確。

---

## 第三部分：建立 LINE Bot（發送通知用）

### 3.1 建立 LINE Developer 帳號

1. 前往 [LINE Developer Console](https://developers.line.biz/console/)
2. 使用您的 LINE 帳號登入
3. 如果是第一次使用，需要同意開發者條款

### 3.2 建立 Provider

1. 點擊「Create a new provider」
2. 輸入名稱，例如：`長者照護系統`
3. 點擊「Create」

### 3.3 建立 Messaging API Channel

1. 在 Provider 頁面，點擊「Create a new channel」
2. 選擇「Messaging API」
3. 填寫以下資訊：
   - **Channel name**: 樂齡防傾倒
   - **Channel description**: 長者跌倒偵測通知系統
   - **Category**: 健康
   - **Subcategory**: 健康管理
4. 勾選同意條款
5. 點擊「Create」

### 3.4 取得 Channel Secret

1. 進入剛建立的 Channel
2. 點擊「Basic settings」頁籤
3. 找到「Channel secret」
4. 點擊「Copy」複製
5. **記下這個值**（等下要用）

### 3.5 取得 Channel Access Token

1. 點擊「Messaging API」頁籤
2. 滾動到最下方「Channel access token」
3. 點擊「Issue」產生 Token
4. 點擊「Copy」複製
5. **記下這個值**（等下要用）

### 3.6 加入 Bot 好友

1. 在「Messaging API」頁籤
2. 找到 QR Code
3. 用手機 LINE 掃描加入好友

---

## 第四部分：設定 API 金鑰

您可以選擇以下任一方式設定：

### 方法一：使用 .env 檔案（推薦）

1. 複製範本檔案：
   ```bash
   copy .env.example .env
   ```

2. 用記事本打開 `.env` 檔案

3. 填入您的金鑰：
   ```
   LINE_CHANNEL_ACCESS_TOKEN=在此貼上您的Channel Access Token
   LINE_CHANNEL_SECRET=在此貼上您的Channel Secret
   LINE_USER_ID=在此貼上您的User ID
   ```

4. 儲存檔案

### 方法二：使用 config.json

編輯 `config.json` 檔案：

```json
{
    "line_bot": {
        "channel_access_token": "在此貼上您的Channel Access Token",
        "channel_secret": "在此貼上您的Channel Secret",
        "user_id": "在此貼上您的User ID"
    }
}
```

### 4.1 取得您的 LINE User ID

**方法一：從 LINE Developer Console**

1. 前往 LINE Developer Console
2. 進入您的 Channel → Basic settings
3. 找到「Your user ID」
4. 這就是您的 User ID

**方法二：設定 Webhook 接收訊息**

詳見 README.md 說明

---

## 第五部分：執行程式

### 5.1 啟動跌倒偵測系統

```bash
python app.py
```

### 5.2 操作說明

| 按鍵 | 功能 |
|------|------|
| `q` 或 `ESC` | 退出程式 |
| `c` | 校準（站立時按下，建立基準線） |
| `r` | 重置警報冷卻時間 |
| `s` | 手動截圖 |

### 5.3 系統運作說明

- 畫面左上角顯示即時資訊面板（FPS、角度、狀態）
- 連續偵測到異常 5 幀後觸發警報
- 發送通知後 30 秒內不會重複發送（冷卻時間）
- 截圖會儲存在 `screenshots` 資料夾

### 5.4 指定攝影機（選用）

如果有多個攝影機：
```bash
python app.py --camera 1
```

### 5.5 指定設定檔（選用）

```bash
python app.py --config /path/to/config.json
```

---

## 第六部分：測試驗證

### 6.1 測試清單

| 測試項目 | 預期結果 | ✓ |
|---------|---------|---|
| 執行 app.py | 顯示攝影機畫面和骨架 | ☐ |
| 站立時按 c 鍵 | 顯示「校準完成」 | ☐ |
| 傾斜身體測試 | 資訊面板顯示角度變化 | ☐ |
| 模擬跌倒 | 畫面邊框變紅，收到 LINE 通知 | ☐ |
| 檢查 screenshots 資料夾 | 有儲存跌倒圖片 | ☐ |

### 6.2 測試跌倒偵測

1. 執行 `python app.py`
2. 站在攝影機前，按 `c` 鍵校準
3. 緩慢傾斜身體或蹲下
4. 觀察資訊面板的角度變化
5. 當角度超過閾值時，應該會收到 LINE 通知

---

## 第七部分：常見問題排解

### Q1: 出現「No module named 'xxx'」錯誤

**解決方法：**
```bash
pip install -r requirements.txt
```

### Q2: 出現「攝影機無法開啟」錯誤

**可能原因：**
- 攝影機被其他程式佔用
- 攝影機驅動程式問題

**解決方法：**
1. 關閉其他使用攝影機的程式（如 Zoom、Teams）
2. 嘗試其他 camera ID：`python app.py --camera 1`
3. 重新執行程式

### Q3: LINE 通知沒有收到

**檢查項目：**
1. `.env` 或 `config.json` 中的金鑰是否正確
2. 是否已加入 Bot 好友
3. LINE_USER_ID / user_id 是否正確

### Q4: 誤報太多？

**調整方法：**
編輯 `config.json`：
```json
{
    "detection": {
        "torso_angle_threshold": 40,
        "consecutive_frames_threshold": 10,
        "cooldown_seconds": 60
    }
}
```

- 增加 `torso_angle_threshold`（如 40°）
- 增加 `consecutive_frames_threshold`（如 10）
- 增加 `cooldown_seconds`（如 60）

### Q5: 漏報太多？

**調整方法：**
```json
{
    "detection": {
        "torso_angle_threshold": 30,
        "consecutive_frames_threshold": 3
    }
}
```

---

## 第八部分：檔案結構說明

```
elderly_fall_detection/
├── app.py                     # 主程式
├── config.json                # 設定檔
├── .env.example               # 環境變數範本
├── requirements.txt           # Python 套件需求
├── 安裝教學.md                # 本文件
├── README.md                  # 專案說明
├── pose_detection/            # 姿勢偵測模組
│   ├── __init__.py
│   ├── detector.py            # 骨架偵測器
│   ├── fall_detector.py       # 跌倒偵測邏輯
│   └── utils/
│       ├── __init__.py
│       └── angle_calc.py      # 角度計算
├── line_bot/                  # LINE Bot 模組
│   ├── __init__.py
│   ├── bot.py                 # Python 版本
│   └── ...
└── screenshots/               # 警報截圖目錄（自動建立）
```

---

## 第九部分：進階設定

### 9.1 開機自動執行

1. 按 `Win + R`
2. 輸入 `shell:startup`
3. 在開啟的資料夾中建立捷徑
4. 捷徑目標設定為：
   ```
   python "D:\20251206\elderly_fall_detection\app.py"
   ```

### 9.2 使用 IP 攝影機

修改 `config.json`：
```json
{
    "camera": {
        "device_id": "rtsp://帳號:密碼@IP位址:埠號/stream"
    }
}
```

或使用命令列參數。

---

## 聯絡與支援

如有問題，請參考 README.md 或聯絡開發者。

---

**祝您部署順利！**
